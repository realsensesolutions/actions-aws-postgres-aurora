name: Test Action

on:
  push:
    branches:
      - main
  workflow_dispatch:

env:
  region: us-east-1

jobs:
  validate:
    name: Validate
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: hashicorp/setup-terraform@v3

      - name: Terraform Format
        run: terraform fmt -check -recursive terraform/

      - name: Terraform Validate
        working-directory: terraform
        run: |
          cat > backend_override.tf <<'EOF'
          terraform {
            backend "local" {
              path = "test.tfstate"
            }
          }
          EOF
          terraform init -backend=false
          terraform validate

  integration:
    name: Integration Test
    runs-on: ubuntu-latest
    needs: validate

    permissions:
      id-token: write
      contents: read

    steps:
      - uses: actions/checkout@v4

      - uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ env.region }}
          role-to-assume: ${{ secrets.AWS_ROLE_ARN }}
          role-session-name: ${{ github.repository_owner }}-${{ github.actor }}

      - name: Setup Terraform Backend
        uses: alonch/actions-aws-backend-setup@main
        with:
          instance: test-aurora-action

      - name: Deploy Aurora
        uses: ./
        id: aurora
        with:
          name: test-aurora-action
          action: destroy
          vpc_id: ${{ secrets.TEST_VPC_ID }}
          subnet_ids: ${{ secrets.TEST_SUBNET_IDS }}
          deletion_protection_enabled: 'false'
          min_capacity: '0.5'
          max_capacity: '2'

      - name: Display Outputs
        run: |
          echo "=== Aurora Outputs ==="
          echo "Endpoint: ${{ steps.aurora.outputs.cluster_endpoint }}"
          echo "ARN: ${{ steps.aurora.outputs.cluster_arn }}"
          echo "Secret: ${{ steps.aurora.outputs.secret_arn }}"
          echo "Database: ${{ steps.aurora.outputs.database_name }}"

      - name: Test Credentials
        run: |
          SECRET=$(aws secretsmanager get-secret-value \
            --secret-id ${{ steps.aurora.outputs.secret_arn }} \
            --query 'SecretString' --output text)
          
          if [ -n "$SECRET" ]; then
            echo "âœ… Credentials retrieved"
            echo "Host: $(echo $SECRET | jq -r '.host')"
          else
            echo "âŒ Failed"
            exit 1
          fi

      # - name: Cleanup
      #   if: always()
      #   uses: ./
      #   with:
      #     name: test-aurora-action
      #     action: destroy
      #     vpc_id: ${{ secrets.TEST_VPC_ID }}
      #     subnet_ids: ${{ secrets.TEST_SUBNET_IDS }}
